%% Pictionary architecture (detailed)
flowchart LR
  subgraph CLIENT["Client Layer (Browser Tabs)"]
    U["Host + Guessers"]
    UI["UIController<br/>screen/forms/theme/scores"]
    GC["GameClient<br/>socket events + room sync"]
    DC["DrawingCanvas<br/>strokes + snapshot sync + resize recovery"]
    DOM["index.html + styles.css"]
    STORE["sessionStorage/localStorage<br/>playerName/theme/sessionToken"]

    U --> UI
    UI --> DOM
    UI --> GC
    UI --> DC
    UI --> STORE
    DC -- "drawCommand + snapshot" --> GC
  end

  subgraph FE["Frontend Hosting"]
    WDS["Webpack Dev Server :8087"]
    PROXY["Proxy<br/>/socket.io + /api"]
    STATIC["Static Bundle Host"]
    WDS --> PROXY
  end

  subgraph BE["Backend (Node + Socket.IO)"]
    ENV[".env/config<br/>PORT/REDIS_URL/DATABASE_URL/JWT_SECRET"]
    EX["Express + HTTP"]
    SOCK["Socket.IO Gateway"]
    AUTH["authMiddleware<br/>jwt/anon identity"]

    subgraph CORE["Realtime Core"]
      GH["gameHandler<br/>room lifecycle"]
      ROUND["round engine<br/>startRound/endRound"]
      SCORE["guess validator + scoring"]
      RECON["reconnect recovery"]
    end

    subgraph SVC["Services"]
      WORD["wordService"]
      LEAD["leaderboardService"]
    end

    ENV --> EX
    EX --> SOCK --> AUTH --> GH
    GH --> ROUND
    GH --> SCORE
    GH --> RECON
    ROUND --> WORD
    SCORE --> LEAD
  end

  subgraph DATA["Data Layer"]
    REDIS[("Redis")]
    RKEYS["Keys<br/>room:*<br/>game:*<br/>drawing:*<br/>session:*<br/>leaderboard"]
    PG[("PostgreSQL<br/>persistent records")]
    REDIS --> RKEYS
  end

  GC <--> |"WebSocket<br/>createRoom/joinRoom/startGame<br/>drawCommand/makeGuess/playerReconnect"| SOCK
  SOCK --> |"roomUpdate/roundStart/gameState<br/>drawingSync/yourWord/guessResult/gameEnd"| GC

  GC -. "HTTP + WS" .-> WDS
  PROXY -. "upstream proxy" .-> EX
  STATIC --> EX

  GH --> |"state reads/writes<br/>drawing history<br/>session tokens"| REDIS
  RECON --> |"session mapping"| REDIS
  LEAD --> |"leaderboard updates"| REDIS
  LEAD --> |"optional persistence"| PG

---

%% Pictionary realtime round flow (detailed)
flowchart LR
  subgraph ACTORS["Actors"]
    H["Host/Drawer"]
    G["Guessers"]
  end

  subgraph RT["Realtime Engine"]
    SIO["Socket.IO"]
    HAND["gameHandler"]
    TICK["round timer tick"]
    VAL["guess check + scoring"]
    SIO --> HAND
    HAND --> TICK
    HAND --> VAL
  end

  subgraph STATE["State"]
    R[("Redis")]
    K["room/game/drawing/session/leaderboard keys"]
    R --> K
  end

  N1["1) Host starts game"]
  N2["2) select drawer + word + round time"]
  N3["3) emit roundStart + yourWord"]
  N4["4) host sends drawCommand + snapshot"]
  N5["5) relay drawingSync to room"]
  N6["6) guessers send makeGuess"]
  N7["7) emit guessResult + gameState"]
  N8["8) nextRound or gameEnd"]

  H --> N1 --> SIO
  SIO --> HAND --> N2 --> N3 --> SIO

  H --> N4 --> SIO --> N5 --> G
  G --> N6 --> SIO --> VAL --> N7 --> SIO
  TICK --> N7
  N7 --> H
  N7 --> G
  VAL --> N8

  HAND --> |"state reads/writes"| R
